<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOCGODAI - í•™ìŠµ í”Œë«í¼</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Navigation Bar */
        .navbar {
            background: rgba(0, 0, 0, 0.3);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .navbar-brand {
            font-size: 1.5em;
            font-weight: 700;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .socket-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .socket-connected {
            background: #28a745;
            box-shadow: 0 0 8px #28a745;
        }

        .socket-disconnected {
            background: #dc3545;
        }

        /* Breadcrumb */
        .breadcrumb {
            background: rgba(255, 255, 255, 0.2);
            padding: 12px 30px;
            color: white;
            font-size: 0.95em;
        }

        .breadcrumb a {
            color: white;
            text-decoration: none;
            margin: 0 5px;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        /* Page */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Card */
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .card p.subtitle {
            color: #6c757d;
            margin-bottom: 30px;
        }

        /* Form */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Button */
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }

        .btn-outline {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
        }

        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        /* Course Card */
        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .course-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }

        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-color: #667eea;
        }

        .course-card h3 {
            color: #333;
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .course-card p {
            color: #6c757d;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .course-card .meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            color: #6c757d;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-completed {
            background: #d4edda;
            color: #155724;
        }

        .badge-pending {
            background: #fff3cd;
            color: #856404;
        }

        .badge-easy {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-medium {
            background: #fff3cd;
            color: #856404;
        }

        .badge-hard {
            background: #f8d7da;
            color: #721c24;
        }

        /* Chapter List */
        .chapter-list {
            list-style: none;
            margin-top: 20px;
        }

        .chapter-item {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 5px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chapter-item:hover {
            background: #e9ecef;
            transform: translateX(10px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .chapter-item .title {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .chapter-item .description {
            color: #6c757d;
            font-size: 0.95em;
        }

        /* Learning Section */
        .learning-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .learning-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .learning-section .content {
            line-height: 1.8;
            color: #333;
            font-size: 1.05em;
        }

        .learning-section .empty {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 40px;
        }

        /* Quiz */
        .quiz-options {
            margin-top: 20px;
        }

        .quiz-option {
            display: block;
            padding: 15px;
            margin-bottom: 12px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quiz-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .quiz-option input {
            margin-right: 12px;
        }

        .quiz-result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            font-weight: 600;
        }

        .quiz-result.correct {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .quiz-result.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }

        /* Socket Events */
        .socket-events {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            max-height: 250px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .socket-event {
            padding: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
            background: white;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .socket-event .time {
            color: #6c757d;
            font-size: 0.85em;
        }

        .socket-event .event-name {
            font-weight: 600;
            color: #667eea;
            margin-right: 10px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Progress */
        .progress-bar {
            background: #e9ecef;
            height: 8px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <div class="navbar">
        <div class="navbar-brand">ğŸ“ DOCGODAI</div>
        <div class="navbar-user" id="navbarUser" style="display: none;">
            <span id="userEmail"></span>
            <span>
                <span class="socket-status" id="socketStatus"></span>
                <span id="socketStatusText">ì—°ê²° ì¤‘...</span>
            </span>
            <button class="btn btn-secondary" onclick="logout()" style="padding: 8px 20px;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <!-- Breadcrumb -->
    <div class="breadcrumb" id="breadcrumb"></div>

    <div class="container">
        <!-- ========== AUTH PAGE ========== -->
        <div id="authPage" class="page active">
            <div class="card">
                <h1>í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‘‹</h1>
                <p class="subtitle">AI ê¸°ë°˜ ë§ì¶¤í˜• í•™ìŠµ í”Œë«í¼ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</p>

                <div class="grid">
                    <div>
                        <h2>íšŒì›ê°€ì…</h2>
                        <div class="form-group">
                            <label>ì´ë©”ì¼</label>
                            <input type="email" id="signupEmail" placeholder="student@example.com">
                        </div>
                        <div class="form-group">
                            <label>ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="signupPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                        </div>
                        <button class="btn" onclick="signup()">íšŒì›ê°€ì…</button>
                    </div>

                    <div>
                        <h2>ë¡œê·¸ì¸</h2>
                        <div class="form-group">
                            <label>ì´ë©”ì¼</label>
                            <input type="email" id="loginEmail" placeholder="student@example.com">
                        </div>
                        <div class="form-group">
                            <label>ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                        </div>
                        <button class="btn" onclick="login()">ë¡œê·¸ì¸</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== COURSE LIST PAGE ========== -->
        <div id="courseListPage" class="page">
            <div class="card">
                <h1>ë‚´ ê°•ì˜ ëª©ë¡ ğŸ“š</h1>
                <p class="subtitle">í•™ìŠµí•˜ê³  ì‹¶ì€ ì£¼ì œë¥¼ ì„ íƒí•˜ì„¸ìš”</p>

                <button class="btn" onclick="showPage('createCoursePage')">â• ìƒˆ ê°•ì˜ ë§Œë“¤ê¸°</button>

                <div class="course-grid" id="courseGrid">
                    <!-- Courses will be loaded here -->
                </div>
            </div>

            <!-- Socket Events -->
            <div class="card">
                <h2>ğŸ“¡ ì‹¤ì‹œê°„ ì²˜ë¦¬ í˜„í™©</h2>
                <div class="socket-events" id="socketEvents">
                    <p style="color: #6c757d; text-align: center;">Socket.IO ì´ë²¤íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                </div>
            </div>
        </div>

        <!-- ========== CREATE COURSE PAGE ========== -->
        <div id="createCoursePage" class="page">
            <div class="card">
                <h1>ìƒˆ ê°•ì˜ ë§Œë“¤ê¸° âœ¨</h1>
                <p class="subtitle">í•™ìŠµí•˜ê³  ì‹¶ì€ ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>

                <div class="form-group">
                    <label>ê°•ì˜ ì œëª©</label>
                    <input type="text" id="courseTitle" placeholder="ì˜ˆ: íŒŒì´ì¬ ê¸°ì´ˆ ì™„ì „ì •ë³µ">
                </div>

                <div class="form-group">
                    <label>ê°•ì˜ ì„¤ëª…</label>
                    <textarea id="courseDescription" placeholder="ì´ ê°•ì˜ì—ì„œ ë¬´ì—‡ì„ ë°°ìš¸ ìˆ˜ ìˆë‚˜ìš”?"></textarea>
                </div>

                <div class="form-group">
                    <label>ë‚œì´ë„</label>
                    <select id="courseDifficulty" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                        <option value="easy">ì‰¬ì›€ (Easy)</option>
                        <option value="medium">ë³´í†µ (Medium)</option>
                        <option value="hard">ì–´ë ¤ì›€ (Hard)</option>
                    </select>
                </div>

                <button class="btn" onclick="createCourse()">ê°•ì˜ ë§Œë“¤ê¸°</button>
                <button class="btn btn-outline" onclick="showPage('courseListPage')">ì·¨ì†Œ</button>
            </div>
        </div>

        <!-- ========== CHAPTER LIST PAGE ========== -->
        <div id="chapterListPage" class="page">
            <div class="card">
                <h1 id="courseTitle"></h1>
                <p class="subtitle" id="courseDescription"></p>

                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="showPage('createChapterPage')">â• ìƒˆ ì±•í„° ì¶”ê°€</button>
                    <button class="btn btn-outline" onclick="showPage('courseListPage')">â† ê°•ì˜ ëª©ë¡ìœ¼ë¡œ</button>
                </div>

                <ul class="chapter-list" id="chapterList">
                    <!-- Chapters will be loaded here -->
                </ul>
            </div>
        </div>

        <!-- ========== CREATE CHAPTER PAGE ========== -->
        <div id="createChapterPage" class="page">
            <div class="card">
                <h1>ìƒˆ ì±•í„° ë§Œë“¤ê¸° ğŸ“–</h1>
                <p class="subtitle">í•™ìŠµí•˜ê³  ì‹¶ì€ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”</p>

                <div class="form-group">
                    <label>ì§ˆë¬¸ / ì£¼ì œ</label>
                    <input type="text" id="chapterTitle" placeholder="ì˜ˆ: íŒŒì´ì¬ ë¦¬ìŠ¤íŠ¸ì™€ íŠœí”Œì˜ ì°¨ì´ê°€ ë­ì˜ˆìš”?">
                </div>

                <div class="form-group">
                    <label>ì¶”ê°€ ì„¤ëª… (ì„ íƒ)</label>
                    <textarea id="chapterDescription" placeholder="ë” ìì„¸íˆ ì•Œê³  ì‹¶ì€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>

                <button class="btn" onclick="createChapter()">ì±•í„° ë§Œë“¤ê¸°</button>
                <button class="btn btn-outline" onclick="backToChapterList()">ì·¨ì†Œ</button>
            </div>
        </div>

        <!-- ========== LEARNING PAGE ========== -->
        <div id="learningPage" class="page">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h1 id="learningTitle"></h1>
                        <span id="learningStatus"></span>
                    </div>
                    <button class="btn btn-outline" onclick="backToChapterList()">â† ì±•í„° ëª©ë¡ìœ¼ë¡œ</button>
                </div>

                <!-- Concept Section -->
                <div class="learning-section">
                    <h3>ğŸ“ ê°œë… ì •ë¦¬</h3>
                    <div id="conceptContent" class="content">
                        <div class="empty">AIê°€ ê°œë…ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</div>
                    </div>
                </div>

                <!-- Exercise Section -->
                <div class="learning-section">
                    <h3>ğŸ’» ì‹¤ìŠµ ê³¼ì œ</h3>
                    <div id="exerciseContent" class="content">
                        <div class="empty">AIê°€ ì‹¤ìŠµ ê³¼ì œë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</div>
                    </div>
                </div>

                <!-- Quiz Section -->
                <div class="learning-section">
                    <h3>âœ… í€´ì¦ˆ</h3>
                    <div id="quizContent" class="content">
                        <div class="empty">AIê°€ í€´ì¦ˆë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== GLOBAL STATE ==========
        let state = {
            token: null,
            userId: null,
            userEmail: null,
            socket: null,
            currentCourseId: null,
            currentChapterId: null,
            courses: [], // Frontend only: groups chapters by topic
            chapters: []
        };

        const API_BASE = 'http://localhost:8000';

        // ========== PAGE NAVIGATION ==========
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
            updateBreadcrumb(pageId);
        }

        function updateBreadcrumb(pageId) {
            const breadcrumb = document.getElementById('breadcrumb');
            let html = '<a href="#" onclick="showPage(\'courseListPage\')">ğŸ  í™ˆ</a>';

            if (pageId === 'createCoursePage') {
                html += ' > ìƒˆ ê°•ì˜ ë§Œë“¤ê¸°';
            } else if (pageId === 'chapterListPage') {
                const course = state.courses.find(c => c.id === state.currentCourseId);
                html += ` > <a href="#" onclick="showPage('chapterListPage')">${course ? course.title : 'ê°•ì˜'}</a>`;
            } else if (pageId === 'createChapterPage') {
                const course = state.courses.find(c => c.id === state.currentCourseId);
                html += ` > <a href="#" onclick="showPage('chapterListPage')">${course ? course.title : 'ê°•ì˜'}</a> > ìƒˆ ì±•í„°`;
            } else if (pageId === 'learningPage') {
                const course = state.courses.find(c => c.id === state.currentCourseId);
                const chapter = state.chapters.find(ch => ch.id === state.currentChapterId);
                html += ` > <a href="#" onclick="showPage('chapterListPage')">${course ? course.title : 'ê°•ì˜'}</a>`;
                html += ` > ${chapter ? chapter.title : 'í•™ìŠµ í˜ì´ì§€'}`;
            } else if (pageId === 'courseListPage') {
                // Already set to home
            } else {
                html = '';
            }

            breadcrumb.innerHTML = html;
        }

        // ========== SOCKET.IO ==========
        function connectSocket() {
            state.socket = io(API_BASE);

            state.socket.on('connect', () => {
                addSocketEvent('ì—°ê²°', 'Socket.IO ì„œë²„ ì—°ê²° ì„±ê³µ');
                updateSocketStatus(true);
            });

            state.socket.on('disconnect', () => {
                addSocketEvent('ì—°ê²°', 'Socket.IO ì„œë²„ ì—°ê²° ëŠê¹€');
                updateSocketStatus(false);
            });

            state.socket.on('chapter_processing_started', (data) => {
                addSocketEvent('chapter_processing_started', `ì±•í„° ìƒì„± ì‹œì‘: ${data.title}`);
            });

            state.socket.on('concept_processing', (data) => {
                addSocketEvent('concept_processing', `ê°œë… ì •ë¦¬ AI ìƒì„± ì¤‘...`);
            });

            state.socket.on('concept_completed', (data) => {
                addSocketEvent('concept_completed', `âœ… ê°œë… ì •ë¦¬ ì™„ë£Œ!`);
                if (state.currentChapterId === data.chapter_id) {
                    loadLearningPage(data.chapter_id);
                }
            });

            state.socket.on('exercise_processing', (data) => {
                addSocketEvent('exercise_processing', `ì‹¤ìŠµ ê³¼ì œ AI ìƒì„± ì¤‘...`);
            });

            state.socket.on('exercise_completed', (data) => {
                addSocketEvent('exercise_completed', `âœ… ì‹¤ìŠµ ê³¼ì œ ì™„ë£Œ!`);
                if (state.currentChapterId === data.chapter_id) {
                    loadLearningPage(data.chapter_id);
                }
            });

            state.socket.on('quiz_processing', (data) => {
                addSocketEvent('quiz_processing', `í€´ì¦ˆ AI ìƒì„± ì¤‘...`);
            });

            state.socket.on('quiz_completed', (data) => {
                addSocketEvent('quiz_completed', `âœ… í€´ì¦ˆ ì™„ë£Œ!`);
                if (state.currentChapterId === data.chapter_id) {
                    loadLearningPage(data.chapter_id);
                }
            });

            state.socket.on('all_completed', (data) => {
                addSocketEvent('all_completed', `ğŸ‰ ëª¨ë“  ì½˜í…ì¸  ìƒì„± ì™„ë£Œ!`);
                if (state.currentChapterId === data.chapter_id) {
                    loadLearningPage(data.chapter_id);
                }
                loadCourses(); // Refresh course list
            });
        }

        function updateSocketStatus(connected) {
            const statusDot = document.getElementById('socketStatus');
            const statusText = document.getElementById('socketStatusText');

            if (connected) {
                statusDot.className = 'socket-status socket-connected';
                statusText.textContent = 'ì—°ê²°ë¨';
            } else {
                statusDot.className = 'socket-status socket-disconnected';
                statusText.textContent = 'ì—°ê²° ëŠê¹€';
            }
        }

        function joinChapterRoom(chapterId) {
            if (state.socket) {
                state.socket.emit('join_chapter', { chapter_id: chapterId });
                addSocketEvent('join_chapter', `ì±•í„° ë£¸ ì°¸ì—¬: ${chapterId}`);
            }
        }

        function addSocketEvent(eventName, message) {
            const eventsDiv = document.getElementById('socketEvents');
            const eventDiv = document.createElement('div');
            eventDiv.className = 'socket-event';

            const now = new Date().toLocaleTimeString();
            eventDiv.innerHTML = `
                <span class="time">[${now}]</span>
                <span class="event-name">${eventName}</span>
                <span>${message}</span>
            `;

            eventsDiv.insertBefore(eventDiv, eventsDiv.firstChild);

            while (eventsDiv.children.length > 20) {
                eventsDiv.removeChild(eventsDiv.lastChild);
            }
        }

        // ========== AUTH ==========
        async function signup() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;

            if (!email || !password) {
                alert('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/v1/member/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('íšŒì›ê°€ì… ì„±ê³µ! ì´ì œ ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                    document.getElementById('signupEmail').value = '';
                    document.getElementById('signupPassword').value = '';
                } else {
                    alert(`íšŒì›ê°€ì… ì‹¤íŒ¨: ${data.detail}`);
                }
            } catch (error) {
                alert(`ì—ëŸ¬ ë°œìƒ: ${error.message}`);
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/v1/member/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    state.token = data.access_token;
                    state.userId = data.member.id;
                    state.userEmail = data.member.email;

                    document.getElementById('navbarUser').style.display = 'flex';
                    document.getElementById('userEmail').textContent = state.userEmail;

                    connectSocket();
                    loadCourses();
                    showPage('courseListPage');

                    addSocketEvent('ë¡œê·¸ì¸', `${state.userEmail} ë¡œê·¸ì¸ ì„±ê³µ`);
                } else {
                    alert(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${data.detail}`);
                }
            } catch (error) {
                alert(`ì—ëŸ¬ ë°œìƒ: ${error.message}`);
            }
        }

        function logout() {
            if (state.socket) {
                state.socket.disconnect();
            }

            state = {
                token: null,
                userId: null,
                userEmail: null,
                socket: null,
                currentCourseId: null,
                currentChapterId: null,
                courses: [],
                chapters: []
            };

            document.getElementById('navbarUser').style.display = 'none';
            showPage('authPage');
            alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤');
        }

        // ========== COURSES (Frontend grouping) ==========
        async function loadCourses() {
            try {
                const response = await fetch(`${API_BASE}/v1/chapter/?owner_id=${state.userId}`);
                const chapters = await response.json();

                // Group chapters into "courses" based on similarity
                // For demo: each chapter is its own course
                state.courses = chapters.map(chapter => ({
                    id: chapter.id,
                    title: chapter.title,
                    description: chapter.description || 'í•™ìŠµ ì¤‘...',
                    difficulty: 'easy', // Can be enhanced
                    status: chapter.status,
                    chapterCount: 1,
                    created_at: chapter.created_at
                }));

                renderCourses();
            } catch (error) {
                alert(`ê°•ì˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        function renderCourses() {
            const grid = document.getElementById('courseGrid');
            grid.innerHTML = '';

            if (state.courses.length === 0) {
                grid.innerHTML = '<div class="empty-state"><p>ì•„ì§ ìƒì„±ëœ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ìƒˆ ê°•ì˜ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p></div>';
                return;
            }

            state.courses.forEach(course => {
                const card = document.createElement('div');
                card.className = 'course-card';
                card.onclick = () => viewCourse(course.id);

                const statusBadge = course.status === 'completed' ?
                    '<span class="badge badge-completed">ì™„ë£Œ</span>' :
                    '<span class="badge badge-pending">ìƒì„± ì¤‘</span>';

                const difficultyBadge = `<span class="badge badge-${course.difficulty}">${course.difficulty}</span>`;

                card.innerHTML = `
                    <h3>${course.title}</h3>
                    <p>${course.description}</p>
                    <div class="meta">
                        <div>
                            ${statusBadge}
                            ${difficultyBadge}
                        </div>
                        <div>${course.chapterCount} ì±•í„°</div>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        function createCourse() {
            // In this simplified version, creating a "course" just shows the chapter creation page
            showPage('createChapterPage');
        }

        function viewCourse(courseId) {
            state.currentCourseId = courseId;
            loadChapters(courseId);
            showPage('chapterListPage');
        }

        // ========== CHAPTERS ==========
        async function loadChapters(courseId) {
            try {
                // In this simplified version, each "course" has only 1 chapter
                const response = await fetch(`${API_BASE}/v1/chapter/?owner_id=${state.userId}`);
                const allChapters = await response.json();

                // Filter to current "course" (which is actually just 1 chapter)
                state.chapters = allChapters.filter(ch => ch.id === courseId);

                const course = state.courses.find(c => c.id === courseId);
                if (course) {
                    document.getElementById('courseTitle').textContent = course.title;
                    document.getElementById('courseDescription').textContent = course.description;
                }

                renderChapters();
            } catch (error) {
                alert(`ì±•í„° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        function renderChapters() {
            const list = document.getElementById('chapterList');
            list.innerHTML = '';

            if (state.chapters.length === 0) {
                list.innerHTML = '<div class="empty-state"><p>ì•„ì§ ì±•í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ìƒˆ ì±•í„°ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!</p></div>';
                return;
            }

            state.chapters.forEach(chapter => {
                const item = document.createElement('li');
                item.className = 'chapter-item';
                item.onclick = () => viewChapter(chapter.id);

                const statusBadge = chapter.status === 'completed' ?
                    '<span class="badge badge-completed">ì™„ë£Œ</span>' :
                    '<span class="badge badge-pending">ìƒì„± ì¤‘</span>';

                item.innerHTML = `
                    <div>
                        <div class="title">${chapter.title}</div>
                        <div class="description">${chapter.description || 'AIê°€ ì½˜í…ì¸ ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...'}</div>
                    </div>
                    <div>${statusBadge}</div>
                `;

                list.appendChild(item);
            });
        }

        async function createChapter() {
            const title = document.getElementById('chapterTitle').value;
            const description = document.getElementById('chapterDescription').value;

            if (!title) {
                alert('ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/v1/chapter/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title,
                        description,
                        owner_id: state.userId
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`ì±•í„°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nAIê°€ ì½˜í…ì¸ ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤.\nì‹¤ì‹œê°„ í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”.`);

                    document.getElementById('chapterTitle').value = '';
                    document.getElementById('chapterDescription').value = '';

                    joinChapterRoom(data.chapter_id);

                    // Reload courses and view the new chapter
                    await loadCourses();
                    state.currentCourseId = data.chapter_id;
                    state.currentChapterId = data.chapter_id;

                    viewChapter(data.chapter_id);
                } else {
                    alert(`ì±•í„° ìƒì„± ì‹¤íŒ¨: ${data.detail}`);
                }
            } catch (error) {
                alert(`ì—ëŸ¬ ë°œìƒ: ${error.message}`);
            }
        }

        function viewChapter(chapterId) {
            state.currentChapterId = chapterId;
            joinChapterRoom(chapterId);
            loadLearningPage(chapterId);
            showPage('learningPage');
        }

        function backToChapterList() {
            if (state.currentCourseId) {
                loadChapters(state.currentCourseId);
                showPage('chapterListPage');
            } else {
                showPage('courseListPage');
            }
        }

        // ========== LEARNING PAGE ==========
        async function loadLearningPage(chapterId) {
            try {
                const response = await fetch(`${API_BASE}/v1/chapter/${chapterId}/learning`);
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('learningTitle').textContent = data.title;

                    const statusClass = data.status === 'completed' ? 'badge-completed' : 'badge-pending';
                    const statusText = data.status === 'completed' ? 'ì™„ë£Œ' : 'AI ìƒì„± ì¤‘';
                    document.getElementById('learningStatus').innerHTML = `<span class="badge ${statusClass}">${statusText}</span>`;

                    // Concept
                    const conceptDiv = document.getElementById('conceptContent');
                    if (data.concept && data.concept.is_complete) {
                        conceptDiv.innerHTML = `
                            <h4>${data.concept.title}</h4>
                            <p>${data.concept.content}</p>
                        `;
                    } else {
                        conceptDiv.innerHTML = '<div class="empty">AIê°€ ê°œë…ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</div>';
                    }

                    // Exercise
                    const exerciseDiv = document.getElementById('exerciseContent');
                    if (data.exercise && data.exercise.is_complete) {
                        exerciseDiv.innerHTML = `
                            <p><strong>ë¬¸ì œ:</strong></p>
                            <p>${data.exercise.question}</p>
                        `;
                    } else {
                        exerciseDiv.innerHTML = '<div class="empty">AIê°€ ì‹¤ìŠµ ê³¼ì œë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</div>';
                    }

                    // Quiz
                    const quizDiv = document.getElementById('quizContent');
                    if (data.quiz && data.quiz.question) {
                        let optionsHtml = '';
                        if (data.quiz.options && Array.isArray(data.quiz.options)) {
                            optionsHtml = data.quiz.options.map((opt, idx) => `
                                <label class="quiz-option">
                                    <input type="radio" name="quizAnswer" value="${opt}">
                                    ${opt}
                                </label>
                            `).join('');
                        }

                        quizDiv.innerHTML = `
                            <p><strong>${data.quiz.question}</strong></p>
                            <div class="quiz-options">
                                ${optionsHtml}
                            </div>
                            <button class="btn" onclick="submitQuiz(${chapterId}, ${data.quiz.id})" style="margin-top: 15px;">ì •ë‹µ ì œì¶œ</button>
                            <div id="quizResult"></div>
                        `;
                    } else {
                        quizDiv.innerHTML = '<div class="empty">AIê°€ í€´ì¦ˆë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</div>';
                    }
                } else {
                    alert(`í•™ìŠµ í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨: ${data.detail}`);
                }
            } catch (error) {
                alert(`ì—ëŸ¬ ë°œìƒ: ${error.message}`);
            }
        }

        async function submitQuiz(chapterId, quizId) {
            const selectedAnswer = document.querySelector('input[name="quizAnswer"]:checked');

            if (!selectedAnswer) {
                alert('ë‹µì„ ì„ íƒí•˜ì„¸ìš”');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/v1/quiz/${chapterId}/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        answer: selectedAnswer.value,
                        member_id: state.userId
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    const resultDiv = document.getElementById('quizResult');
                    const resultClass = data.is_correct ? 'correct' : 'incorrect';
                    const resultText = data.is_correct ? 'ì •ë‹µì…ë‹ˆë‹¤!' : 'ì˜¤ë‹µì…ë‹ˆë‹¤.';

                    resultDiv.className = `quiz-result ${resultClass}`;
                    resultDiv.innerHTML = `
                        ${resultText} (ì ìˆ˜: ${data.score}ì )
                        ${data.explanation ? `<br><br>${data.explanation}` : ''}
                    `;

                    addSocketEvent('í€´ì¦ˆ ì œì¶œ', `ê²°ê³¼: ${resultText}`);
                } else {
                    alert(`í€´ì¦ˆ ì œì¶œ ì‹¤íŒ¨: ${data.detail}`);
                }
            } catch (error) {
                alert(`ì—ëŸ¬ ë°œìƒ: ${error.message}`);
            }
        }

        // ========== INITIALIZATION ==========
        window.onload = () => {
            addSocketEvent('ì‹œìŠ¤í…œ', 'í˜ì´ì§€ ë¡œë“œë¨');
        };
    </script>
</body>
</html>
